#!/bin/bash
STOWOPT="--ignore=ignore --ignore=default"

howto() {
    echo "${0#*/}: Unknown package."
    exit 1
}

set_colors_kitty() {
    cfname="kitty/colors.ignore/$2.Kcolor"
    conf='kitty/.config/kitty/kitty.conf'
    if [[ -f $cfname ]] ; then
        echo "Loading colour scheme: $2"
        sed -E -e "/^# \{\{\{ Define colours/,/^# \}\}\}/ {
            /\{\{\{/r $cfname
            /\}\}\}|\{\{\{/ ! d
    }" "$conf" > temp && mv temp "$conf"
    else
        kitty/.local/bin/cschemes.py kitty/colors.ignore/
    fi
}

set_colors() {
    set_colors_kitty "$@"
}

main() {
    pkgname=$1
    case $pkgname in
        color)
            set_colors "$@"
            exit 0
            ;;
        *)
            [[ -d $1 ]] || howto
            ;;
    esac

    host=$(hostname)
    defaults=$(find "$pkgname" -iname "*\.default")

    for default in $defaults ; do
        fname=${default%.default}
        cp "$default" "$fname"
        if [[ -f "${fname}.${host}.ignore" ]] ; then
            IFS=" ="
            while read -r option ; do
                optionarr=($option)
                sed -Ei "s/^\<${optionarr[0]}\>.*\$/$option/" "$fname"
            done < "${fname}.${host}.ignore"
        fi
        if [[ $pkgname =~ ^kitty/? ]] ; then
            cscheme=($(grep -E "^\<color_scheme\>" "$fname"))
            set_colors_kitty "$pkgname" "${cscheme[1]}" "$fname"
        fi
    done

    stow $STOWOPT "$pkgname"
}

main "$@"

